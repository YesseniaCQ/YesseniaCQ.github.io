---
title: 毕设记录
banner:
  type: video
  bgurl: https://cdn.jsdelivr.net/gh/YesseniaCQ/img/video/心壑/心壑.m3u8
  bannerText: I'm stay with you.
date: 2024-01-02 13:14:40
tags:
cover:
---

```shell
library(ggplot2) 
library(RColorBrewer) #配色
library(patchwork) #拼图
library(magrittr) #管道符
colorCount <- length(unique(grp_order))

p2 <- grp_order %>% as.data.frame() %>% 
    ggplot(aes(x = name, y = 1, color = factor(name))) +
    geom_point(size = 4, show.legend = F) +
    scale_color_manual(values = colorRampPalette(brewer.pal(8, "Set2"))(colorCount)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_x_discrete(limits = unique(grp_order)) +
    theme(legend.position = "none",
       panel.spacing = unit(0, "lines"),
       panel.background = element_blank(),
       panel.border = element_blank(),
       plot.background = element_blank(),
       plot.margin = margin(0, 0, 0, 0, "pt"),
       axis.text.x = element_text(angle = 90,
                                  size = 12,
                                  hjust = 1,
                                  vjust = 0.5,
                                  color = "black"),
       axis.title  = element_blank(),
       axis.ticks = element_blank(),
       panel.grid = element_blank(),
       axis.text.y = element_blank())

library(stringr)  
p4 <- DotPlot(scrnat, features=markers,
             assay='RNA')+ coord_flip() + RotatedAxis() + 
             theme(axis.text.x=element_text(size=0))

p4[avgPctMat$pctExpr < 5] <- 0
p4/p2+plot_layout(height=c(9,0.5))
ggsave("check_marker_by_seurat_cluster.pdf",width=15,height=10)

```


### 找一下marker
```r
markers <- FindAllMarkers(scrnat, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
top5 <- markers %>% group_by(cluster) %>% top_n(n=5,wt=avg_log2FC)
write.table(top5,"marker_top5.csv",row.names=FALSE,col.names=TRUE,sep=",")
```
### RNA气泡图
```r
library(Seurat)

load("../20231222_singleMuti/shareData/qc_atac/testis_combined.annotationCellType.qc.Rdata")
Idents(scrnat)<-"cell_type" #修改active.ident
table(Idents(scrnat))

library(ggplot2) 
library(RColorBrewer) #配色
library(patchwork) #拼图
library(magrittr) #管道符

featureSets <- list(
	"SSC" = c("GFRA1","UTF1"), 
	"Differenting&Differented SPG" = c("KIT","DMRT1","STRA8"), 
	"Leptotene" = c("SPO11","SYCP3"), 
	"Zygotene" = c("SYCP3"), 
	"Patchytene" = c("OVOL1","OVOL2"),
	"Diplotene" = c("NME8"), 
	"Early stage of spermatids" = c("C9orf116","ACR"),
    "Round&ElongateS.tids" = c("TXNDC8","TXNDC2"), 
    "Sperm" = c("TNP1","PRM2"), 
    "Leydig cells" = c("DLK1"), 
    "Sertoli cells" = c("AMH","SOX9"), 
    "Myoid cells" = c("MYH11","ACTA2"), 
    "Pericytes" = c("NOTCH3"),
    "Macrophages" = c("CD68","CD14"),
    "Endothelial cells" = c("VWF","PECAM1"), 
    "NKT cells" = c("NKG7","FGFBP2")
)

grp_order = c("SSC",
"Differenting&Differented SPG",
"Leptotene",
"Zygotene",
"Patchytene",
"Diplotene",
"Early stage of spermatids",
"Round&ElongateS.tids",
"Sperm",
"Leydig cells",
"Myoid cells",
"Pericytes",
"Sertoli cells",
"Endothelial cells",
"NKT cells",
"Macrophages")

gene_order <- c("GFRA1",
"UTF1",
"KIT",
"DMRT1",
"STRA8",
"SPO11",
"SYCP3",
"OVOL1",
"OVOL2",
"NME8",
"C9orf116",
"ACR",
"TXNDC8",
"TXNDC2",
"TNP1",
"PRM2",
"DLK1",
"MYH11",
"ACTA2",
"NOTCH3",
"AMH",
"SOX9",
"VWF",
"PECAM1",
"NKG7",
"FGFBP2",
"CD68",
"CD14")

namedClustAspect <- 1.6

#RNA簇的标记的点图
count_mat <- GetAssayData(object=scrnat,assay="RNA",layer="counts")
count_mat <- as.matrix(count_mat)
avgPctMat <- avgAndPctExpressed(count_mat, scrnat$cell_type, feature_normalize=TRUE, min_pct=0)

#我们关注的基因集
subGenes <- featureSets %>% do.call("c",.)
avgPctMat <- avgPctMat[avgPctMat$feature %in% subGenes,]
avgPctMat <- avgPctMat[avgPctMat$grp %in% grp_order,]

# 阈值最小百分比
avgPctMat$pctExpr[avgPctMat$pctExpr < 5] <- 0

p2 <- grp_order %>% as.data.frame() %>% 
    ggplot(aes(x = grp_order, y = 1, color = factor(grp_order))) +
    geom_point(size = 3, show.legend = F) +
    scale_color_manual(values = colorRampPalette(brewer.pal(8, "Set2"))(colorCount)) +
    scale_y_continuous(expand = c(0,0)) +
    scale_x_discrete(limits = unique(grp_order)) + 
    theme(legend.position = "none",
       panel.spacing = unit(0, "lines"),
       panel.background = element_blank(),
       panel.border = element_blank(),
       plot.background = element_blank(),
       plot.margin = unit(c(0.25,0,0.25,1), "cm"),
       axis.text.x = element_text(angle = 90,
                                  size = 8,
                                  hjust = 1,
                                  vjust = 0.5,
                                  color = "black"),
       axis.title  = element_blank(),
       axis.ticks = element_blank(),
       panel.grid = element_blank(),
       aspect.ratio = 0.05,
       axis.text.y = element_blank()
       )
            
p5 <- dotPlot(
	avgPctMat, xcol="grp", ycol="feature", color_col="avgExpr", size_col="pctExpr", xorder=grp_order, yorder=rev(gene_order), cmap=cmaps_BOR$sunrise, aspectRatio=namedClustAspect) + scale_size_continuous(range=c(1,4)) + 
	theme(axis.text.x=element_text(size=8), axis.text.y = element_text(size=8,face="italic"), panel.border = element_rect(size = 0.2), axis.ticks = element_blank(), legend.title = element_text(size = 8), legend.text = element_text(size = 8), legend.key.size = unit(0.3, "cm")) +
	xlab(NULL) + ylab(NULL) + guides(
	fill = guide_legend(title=""),
	colour = guide_colorbar(title="Relative expression", override.aes = list(size = 3, linetype = 2, shape = 16)),
	size = guide_legend(title="Percentage expressed"))
	
ggsave("RNA_NamedClust_markers_dot_plot_scalp.pdf",width=5,height=6)
```
![[Pasted image 20240104191857.png]]
![[Pasted image 20240104192120.png]]

### ATAC气泡图
```r
library(ArchR)

#当前文件夹/public/download/ycq2022
load("20231222_singleMuti/shareData/qc_atac/testis_combined_peak.combineRNA.qc.Rdata") #因为是他人创建的archr对象，我无法读取依赖，所以最后用的是前三步提取好的矩阵，如下
load("20231222_singleMuti/shareData/qc_atac/GeneScoreMatrix.Rdata")
source("matrix_helpers.R")

# Dot plot of GeneScoreMatrix cluster markers
GSM_se <- getMatrixFromProject(testis_combined_peak_combineRNA, useMatrix="GeneScoreMatrix")
GSM_mat_num <- assays(GSM_se)$GeneScoreMatrix
rownames(GSM_mat) <- rowData(GSM_se)$name

avgPctMat <- avgAndPctExpressed(GSM_mat_num[,getCellNames(peakRNA)], peakRNA$cell_type, feature_normalize=TRUE, min_pct=0)

# Subset to genes we care about:
subGenes <- featureSets %>% do.call("c",.)
avgPctMat <- avgPctMat[avgPctMat$feature %in% subGenes,]
avgPctMat <- avgPctMat[avgPctMat$grp %in% grp_order,]

# Threshold min pct
avgPctMat$pctExpr[avgPctMat$pctExpr < 5] <- 0

p6 <- dotPlot(
	avgPctMat, xcol="grp", ycol="feature", color_col="avgExpr", size_col="pctExpr", xorder=grp_order, yorder=rev(gene_order), cmap=cmaps_BOR$horizonExtra, aspectRatio=namedClustAspect) + scale_size_continuous(range=c(1,4)) + 
	theme(axis.text.x=element_text(size=8), axis.text.y = element_text(size=8,face="italic"), panel.border = element_rect(size = 0.2), axis.ticks = element_blank(), legend.title = element_text(size = 8), legend.text = element_text(size = 8), legend.key.size = unit(0.3, "cm")) +
	xlab(NULL) + ylab(NULL) + guides(
	fill = guide_legend(title=""),
	colour = guide_colorbar(title="Relative gene activity", override.aes = list(size = 3, linetype = 2, shape = 16)),
	size = guide_legend(title="Percentage expressed"))
	
ggsave("outImg/GSM_NamedClust_markers_dot_plot_scalp.pdf",width=5,height=6)
```
### 差异基因热图+富集分析
```r
library(Seurat)

df2 <- as.data.frame(AverageExpression(object = scrnat)$MAGIC_RNA)

library(tidyr)
library(tidyverse)
library(patchwork) #拼图
library(magrittr) #管道符

markers <- FindAllMarkers(scrnat, test.use = "wilcox", # 使用Wilcoxon秩和检验 
							 group.by = "cell_type",
							 min.pct = 0.25,
							 logfc.threshold = 0.25, # 对数折叠变化阈值 
							 only.pos = TRUE, # 只考虑正向差异基因 
							 verbose = TRUE) # 显示详细信息
							 
diff_gene <- markers$gene
exp_diff <- df2[rownames(df2) %in% diff_gene, ]
exp_diff_sorted <- exp_diff[, grp_order] %>% as.matrix()


heatmap1=pheatmap(exp_diff_sorted, scale = "row", cluster_rows = TRUE, clustering_method = "ward.D2", cluster_cols = TRUE, show_rownames = FALSE)
nr=rownames(exp_diff_sorted)[heatmap1$tree_row[["order"]]]
nc=colnames(exp_diff_sorted)[heatmap1$tree_col[["order"]]]

heatmap3=pheatmap(exp_diff_sorted, scale = "row", cluster_rows = T, cluster_cols = F, show_rownames = FALSE,clustering_method = "centroid",
color = colorRampPalette(colors = c("lightsteelblue1","white","red"))(100) , cutree_cols = 16)

pdf("RNA_diffgene_centroid.pdf")
heatmap3
dev.off()

## 富集分析
library(AnnotationDbi)
library(org.Hs.eg.db)#基因注释包 
library(clusterProfiler)#富集包 
library(dplyr) 
library(ggplot2)#画图包

diff_gene.entrezid <- bitr(diff_gene,fromType="SYMBOL",toType="ENTREZID", OrgDb = org.Hs.eg.db)
gene <- diff_gene.entrezid$ENTREZID

enrich.go <- enrichGO(gene = gene,  #待富集的基因列表
    OrgDb = org.Hs.eg.db,  #指定物种的基因数据库，示例物种是绵羊（sheep）
    keyType = 'ENTREZID',  #指定给定的基因名称类型，例如这里以 entrze id 为例
    ont = 'ALL',  #GO Ontology，可选 BP、MF、CC，也可以指定 ALL 同时计算 3 者
    pAdjustMethod = 'fdr',  #指定 p 值校正方法
    pvalueCutoff = 0.05,  #指定 p 值阈值（可指定 1 以输出全部）
    qvalueCutoff = 0.2,  #指定 q 值阈值（可指定 1 以输出全部）
    readable = FALSE)


```

```r"重命名idents的一些方法"
grp_order=c("","","") #要保证新idents的顺序对应

# 法一
scrnat2 <- SetIdent(scrnat2, value = grp_order)

#法二
scrnat2$celltype <- factor(grp_order)
Idents(scrnat)<-"celltype"

#法三
scrnat2$cell_type <- factor(scrnat2$cell_type, levels = grp_order)
```

```r"找对应细胞群makrer"
ESOS=avgPctMat2[avgPctMat2["grp"]=="Early stage of spermatids",] #grp是细胞类型，avgPctMat2可以换成dotplot出的图参数p
head(ESOS[order(-ESOS$avgExpr,-ESOS$pctExpr),]) #-是逆序，从大到小
```